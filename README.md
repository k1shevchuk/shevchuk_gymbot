# GymBot – тренировочный Telegram-бот

Этот проект реализует полнофункционального Telegram-бота для ведения силовых тренировок. Бот построен на Python 3.11+, использует стек `aiogram 3`, `SQLAlchemy 2`, `Alembic`, `APScheduler`, `pandas` и ориентирован на работу через long-polling внутри Docker-контейнера.

## Возможности

- Главное меню с разделами: «Начать тренировку», «Сводка», «План», «Мои рекорды», «История», «Настройки», «Экспорт/Импорт».
- Управление тренировкой через FSM: выбор упражнения, ввод подходов (вес, повторы, RIR), подсказки следующего подхода и завершение тренировки с итоговым отчётом.
- Хранение истории тренировок, подсчёт тоннажа, вывод последних PR и аналитики за 7/28 дней.
- План тренировок по умолчанию с возможностью пересоздания и текстовыми целевыми параметрами (например `3–5` повторений или `скорость`).
- Экспорт всех тренировок в CSV/XLSX и импорт планов/журналов из XLSX, включая диапазоны значений (`3–5`, `6–10 / 45–60 с`, «контроль» и т. п.).
- Настройки пользователя: часовой пояс, единицы измерения (кг/фунты), формат усилия (RIR/RPE), напоминания в будни/выходные, полный сброс данных.
- Планировщик напоминаний на APScheduler, учитывающий часовой пояс пользователя.
- Автотесты (pytest) для ключевых сценариев: импорт, завершение тренировок, сброс профиля.

## Структура проекта

```
app/
├── __init__.py
├── config.py              # Конфигурация через pydantic-settings
├── db.py                  # Создание движка, SessionLocal и хелпера run()
├── models.py              # SQLAlchemy ORM-модели
├── states.py              # FSM-состояния для aiogram
├── keyboards.py           # Reply/Inline клавиатуры
├── scheduler.py           # APScheduler и напоминания
├── run.py                 # Точка входа (long polling)
├── services/
│   ├── progression.py     # План тренировок, расчёт 1RM, рекомендации
│   ├── history.py         # Сводки, история и отчёты
│   ├── prs.py             # Обновление персональных рекордов
│   └── users.py           # Вспомогательные операции с пользователями
└── routers/
    ├── menu.py            # Команды /start и главное меню
    ├── workout.py         # Ведение тренировки и FSM шаги
    ├── summary.py         # Сводка, история, пагинация
    ├── plan.py            # Просмотр рекомендованного плана
    ├── settings.py        # Настройки, включая полный сброс данных
    └── import_export.py   # Экспорт и импорт тренировок

alembic/
├── env.py                 # Настройка Alembic
└── versions/
    ├── 20240605_0001_init.py     # Базовая схема БД
    └── 20240606_0002_textual_targets.py  # Поддержка текстовых целей в плане

Dockerfile                 # Сборка контейнера на python:3.12-slim
requirements.txt           # Зависимости Python
README.md                  # Этот файл
.tests/pytest              # Тесты на pytest (tests/test_workout_flow.py)
```

## База данных

Схема охватывает пользователей, упражнения, тренировки, подходы, метрики, персональные рекорды и связи между ними. Модель `WorkoutExercise` хранит как числовые, так и текстовые целевые параметры (`target_reps_display`, `target_rir_display`), что позволяет импортировать планы с диапазонами («3–5», «скорость») без потери исходного текста.

Все временные поля (`started_at`, `finished_at`) хранятся как timezone-aware `DateTime`. При импорте и завершении тренировок автоматически нормализуется часовой пояс, чтобы избежать ошибок вида «can't subtract offset-naive and offset-aware datetimes».

## Импорт и экспорт

- **Экспорт**: команды «Экспорт CSV/XLSX» формируют временный файл и отправляют его пользователю.
- **Импорт**: бот принимает XLSX с колонками `Date`, `Workout`, `Exercise`, `Set`, `Reps`, `Weight`, `RIR`, `Notes`.
  - Поддерживаются диапазоны, текстовые значения и символ `–`. Первое число используется для числовой статистики, а исходная строка сохраняется для отображения плана.
  - Если в строке нет точных числовых данных (например, только план с «3–5» повторениями), подход не добавляется в таблицу `sets`, но план тренировки будет создан.
  - Новые упражнения создаются автоматически.
- Результат импорта сообщает количество созданных тренировок и подходов.

## Пользовательский опыт

- Главное меню отображается в reply-клавиатуре; все остальные действия управляются inline-кнопками.
- После полного сброса («Полный сброс» в настройках) бот удаляет профиль и связанные записи, убирает клавиатуру и просит снова отправить `/start`, чтобы начать как новый пользователь.
- История тренировок и сводки кэшируются выборками в сервисе `history.py` для ускорения ответов.

## Запуск проекта

### Через Python

1. Создайте и активируйте виртуальное окружение Python 3.11+.
2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
3. Настройте переменные окружения (минимум `BOT_TOKEN`, `DATABASE_URL`, `TZ`). Пример `.env`:
   ```env
   BOT_TOKEN=123456:ABCDEF
   DATABASE_URL=postgresql+psycopg://user:password@db:5432/gymbot
   TZ=Europe/Moscow
   ```
4. Примените миграции Alembic:
   ```bash
   alembic upgrade head
   ```
5. Запустите бота:
   ```bash
   python -m app.run
   ```

### Через Docker

1. Соберите образ:
   ```bash
   docker build -t gymbot .
   ```
2. Настройте `docker-compose.yml` (пример):
   ```yaml
   services:
     bot:
       image: gymbot
       env_file: .env
       depends_on:
         - db
     db:
       image: postgres:15
       environment:
         POSTGRES_DB: gymbot
         POSTGRES_USER: gymbot
         POSTGRES_PASSWORD: secret
   ```
3. Запустите сервисы:
   ```bash
   docker compose up -d
   ```
4. Выполните миграции внутри контейнера бота или отдельного job:
   ```bash
   docker compose exec bot alembic upgrade head
   ```

## Тестирование

Для запуска всех автотестов используйте:

```bash
pytest
```

Тесты создают отдельную SQLite-базу и проверяют ключевые сценарии: импорт данных с учётом часовых поясов и диапазонов, завершение тренировок, полный сброс и корректность поведения FSM-хелперов.

## Полезные заметки

- Планировщик APScheduler запускается вместе с ботом и использует часовой пояс пользователя для напоминаний.
- Для расчёта 1RM используется формула Эпли (`services/progression.py`).
- Сервис `services/prs.py` автоматически обновляет таблицу PR при завершении упражнений.
- Логирование на уровне INFO настроено во всех роутерах и сервисах.

Если вы вносите изменения в схему БД, не забудьте создать новую миграцию Alembic и описать её в README.
